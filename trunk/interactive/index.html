<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>KML Interactive Samples</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <script type="text/javascript" src="ABQIAAAAKkfkHb2nXsD0o1OX2TbdkRRaozj48i9kKhnMmF3N7B7M7uPI0BRRfUKwr6fFsCZXrI626zu0YJBiPQ"></script>
  
  <script type="text/javascript" src="ge-poly-fit-hack.js"></script>
  <script type="text/javascript" src="codemirror/js/codemirror.js"></script>
  <style type="text/css">
    @import "http://ajax.googleapis.com/ajax/libs/dojo/1.1.1/dijit/themes/soria/soria.css";
    @import "http://ajax.googleapis.com/ajax/libs/dojo/1.1.1/dojo/resources/dojo.css";
  </style>
  
  <style type="text/css">@import "index.css";</style>
<script type="text/javascript">
// <![CDATA[

djConfig = { parseOnLoad: true };
google.load('dojo', '1.1.1');

google.load('maps', '2.x');
google.load('earth', '1');

var g_ge;
var g_editor;
var g_earthDisabled = false;
var g_kmlObject;

google.setOnLoadCallback(function() {
  dojo.require('dijit.layout.BorderContainer');
  dojo.require('dijit.layout.SplitContainer');
  dojo.require('dijit.layout.ContentPane');
  dojo.require('dojo.data.ItemFileReadStore');
  dojo.require('dijit.Tree');
  dojo.require('dijit.form.Button');
  dojo.require('dojo.parser');

  dojo.addOnLoad(function() { 
    // build earth
    google.earth.createInstance(
      'map3d',
      function(ge) {
        g_ge = ge;
        g_ge.getWindow().setVisibility(true);
        g_ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
      },
      function() {
        g_earthDisabled = true;
        dijit.byId('update-button').setDisabled(true);
      });
  
    // create code editor
    g_editor = CodeMirror.fromTextArea('editor', {
      parserfile: "parsexml.js",
      stylesheet: "codemirror/css/xmlcolors.css",
      path: "codemirror/js/",
      textWrapping: false,
      continuousScanning: 500,
      initCallback: function(obj) {
        //obj.setCode('test');
      },
      saveFunction: function() {
        reloadKml();
      }
    });
  });
});

function loadSample(path, descPath) {
  dojo.query('iframe', 'center').style('display', 'none');
  dojo.style('editor-loading', 'display', 'block');

  var sampleInstructions = dijit.byId('sample-instructions');
  if (descPath) {
    google.maps.DownloadUrl('../morekml/' + descPath, function(data, httpResponseCode) {
      if (data && httpResponseCode == 200) {
        sampleInstructions.setContent(data);
      } else {
        sampleInstructions.setContent('Error: <em>Cannot load description.</em>');
      }
      
      dojo.style('sample-instructions', 'display', 'block');
      dijit.byId('center').layout();
    });
  } else {
    sampleInstructions.setContent('');
    dojo.style('sample-instructions', 'display', 'none');
    dijit.byId('center').layout();
  }
  
  google.maps.DownloadUrl('../morekml/' + path, function(data, httpResponseCode) {
    if (data && httpResponseCode == 200) {
      g_editor.setCode(data);
      if (!g_earthDisabled)
        reloadKml(data);
      
      dojo.style('editor-loading', 'display', 'none');
      dojo.query('iframe', 'center').style('display', 'block');
    } else {
      alert('Error loading KML: HTTP ' + httpResponseCode.toString());
    }
  });
}

function reloadKml(kmlString) {
  if (!kmlString)
    kmlString = g_editor.getCode();
  
  if (g_kmlObject)
    g_ge.getFeatures().removeChild(g_kmlObject);
  
  try {
    g_kmlObject = g_ge.parseKml(kmlString);
    g_ge.getFeatures().appendChild(g_kmlObject);
  } catch (ex) {
    alert('Error parsing KML!');
    return;
  }

  // see if we should show sky
  // TODO: better parsing!
  if (kmlString.indexOf('target=sky') >= 0)
    g_ge.getOptions().setMapType(g_ge.MAP_TYPE_SKY);
  else
    g_ge.getOptions().setMapType(g_ge.MAP_TYPE_EARTH);
  
  var aspectRatio = dojo.coords('right').w * 1.0 / dojo.coords('right').h;
  var la = computeFitLookAt(g_ge, g_kmlObject, aspectRatio);
  g_ge.getView().setAbstractView(la);
}

// ]]>
</script>
</head>
<body class="soria">
  <div id="container" dojoType="dijit.layout.BorderContainer" region="center" style="height: 100%">
  
    <div id="top" dojoType="dijit.layout.ContentPane" region="top">
      <h1 style="margin:0; padding:0">KML Interactive Samples</h1>
      <p style="margin:0; padding:0">Explore the samples below and then experiment by changing the KML and clicking 'Update Earth'!
      <em>This sampler requires the <a href="http://code.google.com/apis/earth">Google Earth Browser Plug-in</a></em>.</p>
    </div>
    
    <div id="left" dojoType="dijit.layout.ContentPane" region="left"
      splitter="true" minwidth="200" style="width: 200px;">
      
      <div dojoType="dojo.data.ItemFileReadStore" jsid="samplesStore"
        url="kml-samples.json"></div>
      
      <div id="tree" dojoType="dijit.Tree"
        labelAttr="name"
        store="samplesStore"
        style="height: 100%;">
        <script type="dojo/method" event="onClick" args="item">
          if (item) {
            var source = samplesStore.getValue(item, 'source');
            var children = samplesStore.getValue(item, 'children');
            var descSource = samplesStore.getValue(item, 'descSource');
            
            if (source && !children)
              loadSample(source, descSource);
          }
        </script>
        <script type="dojo/method" event="getLabelClass" args="item">
          if (item) {
            var children = samplesStore.getValue(item, 'children');
            if (!children)
              return 'leaf-label';
          }
        </script>
      </div>
      
    </div>
  
    <div id="center" dojoType="dijit.layout.BorderContainer" region="center">
      <div id="edit-toolbar" dojoType="dijit.layout.ContentPane" region="top">
        <div dojoType="dijit.layout.ContentPane" id="sample-instructions">
          <p style="font-style: italic; font-weight: bold; color: #00aa00;">Instructions will appear here if available.</p>
        </div>
        <button id="update-button" dojoType="dijit.form.Button" onclick="reloadKml();">Update Earth!</button>
      </div>
      <div dojoType="dijit.layout.ContentPane" region="center">
<div id="editor-loading" style="width: 100%; height: 100%;">

</div>
<textarea id="editor" style="width: 100%; height: 100%">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;kml xmlns="http://www.opengis.net/kml/2.2"&gt;

&lt;/kml&gt;
</textarea>
      </div>
    </div>
      
    <div id="right" dojoType="dijit.layout.ContentPane" region="right"
      splitter="true" sizerWidth="10" minsize="400" style="width: 400px;">
      <div id="map3d" style="height: 100%"></div>
    </div>
    
    <div id="bottom" dojoType="dijit.layout.ContentPane" region="bottom">
      More samples available at the <a href="http://code.google.com/p/kml-samples/source/browse/#svn/trunk">kml-samples</a> project.
    </div>
  
  </div>
    
</body>
</html>
